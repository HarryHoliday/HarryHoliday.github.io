---
sidebar_position: 3
---

# 2ì£¼

- useState, useEffectë¥¼ ì‚¬ìš©í•œ stateê´€ë¦¬ - 2
- useHook - 1
- recoilë¥¼ ì‚¬ìš©í•œ stateê´€ë¦¬ - 1
  - oktaì—°ë™

---

- ì •ë³´ ê³µìœ  (openssl 3.0 ~ 3.6 ì·¨ì•½ì  ì´ìŠˆ) [ğŸ‘‰ğŸ”—](https://www.openssl.org/news/secadv/20221101.txt)
- ì›¹ í”„ë¡œê·¸ë˜ë°ìœ¼ë¡œ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬í˜„í•˜ì—¬ ì›¹ í˜¸ìŠ¤íŒ…ì„ í†µí•´ ì‚¬ìš©ìì—ê²Œ ì›¹ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•œë‹¤. `ğŸ‘† ì´ ë¬¸ì¥ìœ¼ë¡œ ê·¸ë ¤ì§€ëŠ” ê·¸ë¦¼ì€ ì–´ë–¤ê±´ì§€ ê¶ê¸ˆí•©ë‹ˆë‹¤. ë˜í•œ, ìì‹ ì˜ ê¸€ë¡œ í•œë²ˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”`
- [reactrouter](https://reactrouter.com) í™ˆí˜ì´ì§€ì˜ tutorialì„ ë”°ë¼ í•´ë³´ì„¸ìš”

---

`ğŸ’» coding - start`

```txt
// TODO:
// useEffect
//  - componentDidmount
//  - componentDidUpdate
//  - componentWillUnmount
// useState with no.2
// button click event
// e.stopPropagation();
// e.preventDefault() with link
// useHook
// share state at hierarchical structure [parent, children]
```

- routes/home.tsxë¥¼ ìˆ˜ì •

```tsx
import { useEffect } from "react";

const Home = () => {
  useEffect(() => {
    console.log("home is mounted");
    return () => {
      console.log("home is unmounted");
    };
  }, []);

  return <div>home</div>;
};

export default Home;
```

- í˜ì´ì§€ë¥¼ ì´ë™í•˜ë©´ ì½˜ì†”ë¡œê·¸ë¥¼ í™•ì¸
- strict mode ë•Œë¬¸ì— ë¡œê·¸ê°€ ì´ìƒí•˜ê²Œ í‘œì‹œë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„, í•˜ì§€ë§Œ ì •ìƒ ë¬¸ì„œ í™•ì¸ [ğŸ‘‰ğŸ”—](https://reactjs.org/docs/strict-mode.html#detecting-unexpected-side-effects)

- useStateë¥¼ í†µí•´ ì—…ë°ì´íŠ¸ í›„ì— ë¡œê·¸ê°€ í‘œì‹œë˜ëŠ”ê±¸ í™•ì¸

```tsx
import { useEffect, useState } from "react";

const Home = () => {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    console.log("home is mounted");
    setTimeout(() => {
      setIsReady(true);
    }, 3_000); // 3 * 1000, 3000, 3
    return () => {
      console.log("home is unmounted");
    };
  }, []);

  useEffect(() => {
    console.log("home is updated");
  }, [isReady]);

  return <div>home</div>;
};

export default Home;
```

- isReady stateê°€ ë°”ë€Œë©´ ë¡œê·¸ê°€ í‘œì‹œëœë‹¤

- count ìƒíƒœë¥¼ ì¶”ê°€í•´ì„œ data flowë¥¼ ìƒê°í•´ë³´ì

```tsx
import { MouseEventHandler, useEffect, useState } from "react";

const Home = () => {
  const [isReady, setIsReady] = useState(false);
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("home is mounted");
    setTimeout(() => {
      setIsReady(true);
    }, 3_000); // 3 * 1000, 3000, 3
    return () => {
      console.log("home is unmounted");
    };
  }, []);

  useEffect(() => {
    console.log("home is updated");
  }, [isReady]);

  const handleClick: MouseEventHandler<HTMLButtonElement> = (e) => {
    setCount((currentCount) => currentCount + 1);
  };

  return (
    <button className="btn btn-wide btn-primary" onClick={handleClick}>
      {count}
    </button>
  );
};

export default Home;
```

- event handlingì— ë””í´íŠ¸ì™€ ë²„ë¸”ë§ì— ëŒ€í•´ ì•Œì•„ë³´ì, ì„¸ë¯¸ë‚˜ì‹œ ì½”ë”©

- homeì—ì„œ count stateë¥¼ hooks/useCountë¡œ ë¶„ë¦¬í•´ë³´ì, ë¶„ë¦¬í•˜ë©´ aboutì—ì„œ countìƒíƒœë¥¼ ê³µìœ  ë°›ì„ ìˆ˜ ìˆì„ê¹Œ?
- hooks/useCount.ts

```tsx
import { useState } from "react";

export const useCount = () => {
  const [count, setCount] = useState(0);
  return { count, setCount };
};
```

- home.tsx ìˆ˜ì •

```tsx
import { MouseEventHandler, useEffect, useState } from 'react';
import { useCount } from '../hooks/useCount';

const Home = () => {
  const [isReady, setIsReady] = useState(false);
  const { count, setCount } = useCount();

  ...
};

export default Home;

```

- about.tsxì—ì„œ useCountë¥¼ í†µí•´ countë¥¼ ê°€ì ¸ì™€ë³´ì

```tsx
import { useCount } from "../hooks/useCount";

const About = () => {
  const { count } = useCount();
  return <>{count}</>;
};

export default About;
```

- ê³µìœ ì•ˆë¨
- useStateëŠ” í˜¸ì¶œí•˜ëŠ” ì»´í¬ë„ŒíŠ¸ ë˜ëŠ” ì»¤ìŠ¤í…€ í›…ì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ìƒíƒœë¥¼ ìœ ì§€í•œë‹¤.

- recoilì„ í†µí•´ ìƒíƒœë¥¼ ê³µìœ í•˜ì
- recoil/count.ts ìƒì„±

```ts
import { atom } from "recoil";

export const countState = atom<number>({
  key: "Count",
  default: 0,
});
```

- hooks/useCount.ts ìˆ˜ì •

```ts
import { useRecoilState } from "recoil";
import { countState } from "../recoil/count";

export const useCount = () => {
  const [count, setCount] = useRecoilState(countState);
  return { count, setCount };
};
```

- [okta ğŸ‘‰ğŸ”—](https://www.npmjs.com/package/@okta/okta-auth-js)

- App.tsxì— okta ì„¤ì •

```tsx
import { FC, ReactNode, useEffect, useState } from "react";
import {
  CustomUserClaims,
  OktaAuth,
  OktaAuthOptions,
  UserClaims,
} from "@okta/okta-auth-js";
import logo from "./logo.svg";

type Props = {
  children: ReactNode;
};

const App: FC<Props> = ({ children }) => {
  const [isReady, setIsReady] = useState(false);
  const [userInfo, setUserInfo] = useState<UserClaims<CustomUserClaims> | null>(
    null
  );

  useEffect(() => {
    const init = async () => {
      const config: OktaAuthOptions = {
        issuer: "***",
        clientId: "***",
        scopes: ["email", "openid", "profile"],
        transformAuthState: async (oktaAuth, authState) => {
          if (!authState.isAuthenticated) {
            return authState;
          }
          const user = await oktaAuth.token.getUserInfo();
          authState.isAuthenticated = !!user;
          delete user.headers;
          authState.user = user;
          return authState;
        },
      };

      const authClient: OktaAuth = new OktaAuth(config);
      authClient.authStateManager.subscribe(async (authState) => {
        if (!authState.isAuthenticated) {
          if (authClient.isLoginRedirect()) {
            // console.log('here');
            try {
              await authClient.handleLoginRedirect();
            } catch (error) {
              console.log(error);
            }
          } else {
            authClient.signInWithRedirect();
          }
        }
        if (authState.isAuthenticated) {
          setIsReady(true);
          setUserInfo(authState.user as UserClaims<CustomUserClaims>);
        }
      });
      authClient.authStateManager.updateAuthState();
    };
    init();
  }, []);

  console.log(userInfo);

  if (!isReady) {
    return (
      <div className="App-header">
        <img src={logo} className="App-logo" alt="logo" />
      </div>
    );
  }

  return <>{children}</>;
};

export default App;
```

- configì„¤ì •ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì˜®ê²¨ ë°°í¬í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì ìš© ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤

```tsx
...
const { data: ENV } = await axios.get('/env');
const config: OktaAuthOptions = {
  issuer: ENV?.OKTA_ISSUER,
  clientId: ENV?.OKTA_CLIENT_ID,
  scopes: ENV?.OKTA_SCOPES.split(','),
  transformAuthState: async (oktaAuth, authState) => {
    if (!authState.isAuthenticated) {
      return authState;
    }
    const user = await oktaAuth.token.getUserInfo();
    authState.isAuthenticated = !!user;
    delete user.headers;
    authState.user = user;
    return authState;
  },
};
...
```

- useAppì„ ë§Œë“¤ì–´ App.tsxì—ì„œ oktaê´€ë ¨ ì½”ë“œë¥¼ ì˜®ê¸´ë‹¤

- hooks í´ë”ë¥¼ ìƒì„±, useApp.ts íŒŒì¼ì„ ë§Œë“ ë‹¤
- hooks/useApp.ts

```ts
import { useEffect, useState } from "react";
import {
  CustomUserClaims,
  OktaAuth,
  OktaAuthOptions,
  UserClaims,
} from "@okta/okta-auth-js";
import axios from "axios";

export const useApp = () => {
  const [isAppReady, setIsAppReady] = useState(false);
  const [userInfo, setUserInfo] = useState<UserClaims<CustomUserClaims> | null>(
    null
  );

  useEffect(() => {
    const init = async () => {
      const { data: ENV } = await axios.get("/env");
      const config: OktaAuthOptions = {
        issuer: ENV?.OKTA_ISSUER,
        clientId: ENV?.OKTA_CLIENT_ID,
        scopes: ENV?.OKTA_SCOPES.split(","),
        transformAuthState: async (oktaAuth, authState) => {
          if (!authState.isAuthenticated) {
            return authState;
          }
          const user = await oktaAuth.token.getUserInfo();
          authState.isAuthenticated = !!user;
          delete user.headers;
          authState.user = user;
          return authState;
        },
      };

      const authClient: OktaAuth = new OktaAuth(config);
      authClient.authStateManager.subscribe(async (authState) => {
        if (!authState.isAuthenticated) {
          if (authClient.isLoginRedirect()) {
            // console.log('here');
            try {
              await authClient.handleLoginRedirect();
            } catch (error) {
              console.log(error);
            }
          } else {
            authClient.signInWithRedirect();
          }
        }
        if (authState.isAuthenticated) {
          setIsAppReady(true);
          setUserInfo(authState.user as UserClaims<CustomUserClaims>);
        }
      });
      authClient.authStateManager.updateAuthState();
    };
    init();
  }, []);

  return { isAppReady, userInfo };
};
```

- App.tsx

```tsx
import { FC, ReactNode } from "react";
import logo from "./logo.svg";
import { useApp } from "./hooks/useApp";

type Props = {
  children: ReactNode;
};

const App: FC<Props> = ({ children }) => {
  const { isAppReady } = useApp();
  if (!isAppReady) {
    return (
      <div className="App-header">
        <img src={logo} className="App-logo" alt="logo" />
      </div>
    );
  }

  return <>{children}</>;
};

export default App;
```

- useApp.ts ì—ì„œ axiosë¶€ë¶„ ì½”ë“œë¥¼ fetchersë¡œ ì˜®ê²¨ ê´€ë ¨ ê¸°ëŠ¥ì„ í•¨ìˆ˜ë¡œ ì œê³µí•˜ì
- fetchers í´ë”ë¥¼ ìƒì„±í•˜ê³  getEnv.ts íŒŒì¼ì„ ë§Œë“ ë‹¤
- fetchers/getEnv.ts

```ts
import axios from "axios";

export const getEnv = async () => {
  const { data } = await axios.get("/env");
  return data;
};
```

- useApp.ts ì—ì„œ okë¶€ë¶„ ì½”ë“œë¥¼ helpersë¡œ ì˜®ê²¨ ê´€ë ¨ ê¸°ëŠ¥ì„ í•¨ìˆ˜ë¡œ ì œê³µí•˜ì
- helpers í´ë”ë¥¼ ìƒì„±í•˜ê³  okta.ts íŒŒì¼ì„ ë§Œë“ ë‹¤
- helpers/okta.ts

```ts
import {
  CustomUserClaims,
  OktaAuth,
  OktaAuthOptions,
  UserClaims,
} from "@okta/okta-auth-js";

const getConfig = (ENV: any) => {
  const config: OktaAuthOptions = {
    issuer: ENV?.OKTA_ISSUER,
    clientId: ENV?.OKTA_CLIENT_ID,
    scopes: ENV?.OKTA_SCOPES.split(","),
    transformAuthState: async (oktaAuth, authState) => {
      if (!authState.isAuthenticated) {
        return authState;
      }
      const user = await oktaAuth.token.getUserInfo();
      authState.isAuthenticated = !!user;
      delete user.headers;
      authState.user = user;
      return authState;
    },
  };
  return config;
};

export const initOkta = (
  ENV: any,
  cb: (user: UserClaims<CustomUserClaims>) => void
) => {
  const config = getConfig(ENV);
  const authClient: OktaAuth = new OktaAuth(config);
  authClient.authStateManager.subscribe(async (authState) => {
    if (!authState.isAuthenticated) {
      if (authClient.isLoginRedirect()) {
        // console.log('here');
        try {
          // await authClient.handleLoginRedirect();
          // delay 0.5s
          setTimeout(async () => {
            await authClient.handleLoginRedirect();
          }, 500);
        } catch (error) {
          console.log(error);
        }
      } else {
        authClient.signInWithRedirect();
      }
    }
    if (authState.isAuthenticated) {
      cb(authState.user as UserClaims<CustomUserClaims>);
    }
  });
  authClient.authStateManager.updateAuthState();
};
```

- ìœ„ ë‘ê°€ì§€ ê¸°ëŠ¥ì„ ë‹¤ë¥¸ íŒŒì¼ë¡œ ì˜®ê²¨, hooks/useApp.tsì€ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •ë˜ì—ˆë‹¤

```ts
import { useEffect, useState } from "react";
import { CustomUserClaims, UserClaims } from "@okta/okta-auth-js";
import { getEnv } from "../fetchers/getEnv";
import { initOkta } from "../helpers/okta";

export const useApp = () => {
  const [isAppReady, setIsAppReady] = useState(false);
  const [userInfo, setUserInfo] = useState<UserClaims<CustomUserClaims> | null>(
    null
  );

  useEffect(() => {
    const init = async () => {
      const ENV = await getEnv();
      initOkta(ENV, setUserInfo);
    };
    init();
  }, []);

  useEffect(() => {
    if (userInfo === null) return;
    setIsAppReady(true);
  }, [userInfo]);

  return { isAppReady, userInfo };
};
```

- oktaì—ì„œ ê°€ì ¸ì˜¨ userInfoë¥¼ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê²Œ í•˜ë ¤ë©´?
- ê¸°ë³¸ì ìœ¼ë¡œ reactëŠ” context ë¥¼ ê°€ì§€ê³  ìˆë‹¤ [ğŸ”—](https://ko.reactjs.org/docs/context.html)
- recoilì„ ì‚¬ìš©í•œë‹¤

- index.tsx ìˆ˜ì •

```ts
...
<RecoilRoot>
  <App>
    <RouterProvider router={router} />
  </App>
</RecoilRoot>
...
```

- recoil/userInfoState.ts ë¥¼ ë§Œë“ ë‹¤

```ts
import { CustomUserClaims, UserClaims } from "@okta/okta-auth-js";
import { atom } from "recoil";

export const userInfoState = atom<UserClaims<CustomUserClaims> | null>({
  key: "UserInfo",
  default: null,
});
```

- hooks/useApp.tsë¥¼ ìˆ˜ì •

```ts
import { useEffect, useState } from "react";
import { getEnv } from "../fetchers/getEnv";
import { initOkta } from "../helpers/okta";
import { useRecoilState } from "recoil";
import { userInfoState } from "../recoil/userInfoState";

export const useApp = () => {
  const [isAppReady, setIsAppReady] = useState(false);
  const [userInfo, setUserInfo] = useRecoilState(userInfoState);

  useEffect(() => {
    const init = async () => {
      const ENV = await getEnv();
      initOkta(ENV, setUserInfo);
    };
    init();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (userInfo === null) return;
    setIsAppReady(true);
  }, [userInfo]);

  return { isAppReady, userInfo };
};
```

- Avatarë¥¼ ë§Œë“¤ì–´ Headerì—ì„œ ì‚¬ìš©, AvatarëŠ” userInfoì˜ emailì„ ê°€ì ¸ì™€ ìœ ë‹ˆí¬í•œ ì•„ë°”íƒ€ë¥¼ í‘œí˜„í•œë‹¤
- [BigHead ğŸ”—](https://github.com/RobertBroersma/bigheads)
- ìœ„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ emailì„ ì‚¬ìš©í•´ì„œ ì•„ë°”íƒ€ë¥¼ í‘œí˜„í•˜ë„ë¡ ì»¤ìŠ¤í…€í–ˆë‹¤

- components/Avatar.tsx

```tsx
// @ts-nocheck
import {
  BigHead,
  AvatarProps,
  accessoryMap,
  eyesMap,
  eyebrowsMap,
  bodyMap,
  clothingMap,
  facialHairMap,
  graphicsMap,
  hairMap,
  hatMap,
  mouthsMap,
} from "@bigheads/core";

const convertToNumberString18 = (str: string): AvatarProps => {
  let number = 1;
  for (let i = 0; i < str.length; i++) {
    const charCode = str[i].charCodeAt(0);

    number = Math.floor(number * 2 * charCode);
    if (`${number}`.length > 18) {
      number = Number(`${number}`.slice(0, 18));
    }
  }
  if (`${number}`.length < 18) {
    number = Number(`${number}000000000000000000`.slice(0, 18));
  }

  // return `${number}`;
  const accessory = Object.keys(accessoryMap);
  const eyes = Object.keys(eyesMap);
  const eyebrows = Object.keys(eyebrowsMap);
  const body = Object.keys(bodyMap);
  const clothing = Object.keys(clothingMap);
  const facialHair = Object.keys(facialHairMap);
  const graphic = Object.keys(graphicsMap);
  const hair = Object.keys(hairMap);
  const hat = Object.keys(hatMap);
  const mouth = Object.keys(mouthsMap);
  const faceMaskColor: Pick<AvatarProps, "faceMaskColor"> = [
    "red",
    "black",
    "white",
    "blue",
    "green",
    undefined,
  ];
  const hatColor: Pick<AvatarProps, "hairColor"> = [
    "red",
    "black",
    "white",
    "blue",
    "green",
    undefined,
  ];
  const lipColor: Pick<AvatarProps, "lipColor"> = [
    "red",
    "pink",
    "green",
    "purple",
    "turqoise",
    undefined,
  ];
  const circleColor: Pick<AvatarProps, "circleColor"> = ["blue", undefined];
  const clothingColor: Pick<AvatarProps, "clothingColor"> = [
    "red",
    "black",
    "white",
    "blue",
    "green",
    undefined,
  ];
  const skinTone: Pick<AvatarProps, "skinTone"> = [
    "light",
    "yellow",
    "brown",
    "dark",
    "red",
    "black",
    undefined,
  ];
  const hairColor: Pick<AvatarProps, "hairColor"> = [
    "white",
    "blue",
    "black",
    "brown",
    "blonde",
    "orange",
    "pink",
    undefined,
  ];

  const props: AvatarProps = {
    accessory: accessory[Number(`${number}`[0]) % accessory.length],
    eyes: eyes[Number(`${number}`[1]) % eyes.length],
    eyebrows: eyebrows[Number(`${number}`[2]) % eyebrows.length],
    body: body[Number(`${number}`[3]) % body.length],
    clothing: clothing[Number(`${number}`[4]) % clothing.length],
    facialHair: facialHair[Number(`${number}`[5]) % facialHair.length],
    graphic: graphic[Number(`${number}`[6]) % graphic.length],
    hair: hair[Number(`${number}`[7]) % hair.length],
    hat: hat[Number(`${number}`[8]) % hat.length],
    mouth: mouth[Number(`${number}`[9]) % mouth.length],
    skinTone: skinTone[Number(`${number}`[10]) % skinTone.length],
    hairColor: hairColor[Number(`${number}`[11]) % hairColor.length],
    clothingColor:
      clothingColor[Number(`${number}`[12]) % clothingColor.length],
    circleColor: circleColor[Number(`${number}`[13]) % circleColor.length],
    lipColor: lipColor[Number(`${number}`[14]) % lipColor.length],
    hatColor: hatColor[Number(`${number}`[15]) % hatColor.length],
    faceMaskColor:
      faceMaskColor[Number(`${number}`[16]) % faceMaskColor.length],
    faceMask: !!(Number(`${number}`[17]) % 2),
    mask: true,
    lashes: false,
  };
  return props;
  // console.log(Number(number.slice(-19)));
};

const Avatar: FC<{ email: string }> = ({ email }) => {
  const props = convertToNumberString18(email);

  return <BigHead {...props} />;
};

export default Avatar;
```

- compoents/layout/Header.tsx

```tsx
import { useRecoilValue } from "recoil";
import { userInfoState } from "../../recoil/userInfoState";
import Avatar from "../Avatar";

const Header = () => {
  const userInfo = useRecoilValue(userInfoState);
  return (
    <header className="relative flex flex-row items-center justify-center h-20 min-w-full">
      <div className="w-20">
        <Avatar email={userInfo?.email} />
      </div>
    </header>
  );
};

export default Header;
```
